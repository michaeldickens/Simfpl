;;; Contains a pointer to an object. WARNING: Assumes 64-bit pointers.
%value = type { i64 }

%smpType = type {
;  label, ; superclass
  i8* ; name
}

%smpObject = type { 
  %smpType
}

%smpFixint = type {
  i32
}

@.int_printer = private unnamed_addr constant [4 x i8] c"%d\0A\00", align 1

;;; TODO: Test this.
define %value* @smpFixint_to_value(%smpFixint* %x) {
  %res = alloca %value
  %res_inner = getelementptr %value* %res, i64 0, i32 0
  %ptr = ptrtoint %smpFixint* %x to i64
  store i64 %ptr, i64* %res_inner
  ret %value* %res
}

;;; TODO: Test this.
;;; WARNING: If the passed value does not contain a Fixint, this will still 
;;; try to extract one.
define %smpFixint* @value_to_smpFixint(%value* %x) {
  %res = alloca %smpFixint
  %ptr_ptr = getelementptr %value* %x, i64 0, i32 0
  %ptr_val = load i64* %ptr_ptr
  %ptr = inttoptr i64 %ptr_val to %smpFixint*
  %num = load %smpFixint* %ptr
  store %smpFixint %num, %smpFixint* %res
  ret %smpFixint* %res
}

define i32 @smpFixint_add_internal(%smpFixint* %x, %smpFixint* %y) {
  %xintptr = getelementptr %smpFixint* %x, i64 0, i32 0
  %xint = load i32* %xintptr
  %1 = tail call i32 (i8*, ...)* @printf(i8* getelementptr inbounds ([4 x i8]* @.int_printer, i32 0, i32 0), i32 %xint) nounwind
  %yintptr = getelementptr %smpFixint* %y, i64 0, i32 0
  %yint = load i32* %yintptr
  %res = add i32 %xint, %yint
  ret i32 %res
}

;;; TODO: Finish this.
define %value* @smpFixint_add(%smpFixint* %x, %value* %y) {
  %y_inner = call %smpFixint* @value_to_smpFixint(%value* %y)
  %res_inner = call i32 @smpFixint_add_internal(%smpFixint* %x, 
      %smpFixint* %y_inner)
  %res_smp = call %smpFixint* @make_smpFixint(i32 %res_inner)
  ret %value* %y ; UNFINISHED
}

define i32 @main() {
  %xptr = alloca %smpFixint
  %xptr_inner = getelementptr %smpFixint* %xptr, i64 0, i32 0
  store i32 12, i32* %xptr_inner

  %yptr = alloca %smpFixint
  %yptr_inner = getelementptr %smpFixint* %yptr, i64 0, i32 0
  store i32 8, i32* %yptr_inner

  ;; BUG: the value for y is getting into x somehow.  
  %xvalptr = getelementptr %smpFixint* %xptr, i64 0, i32 0
  %xval = load i32* %xvalptr

  %res = call i32 @smpFixint_add_internal(%smpFixint* %xptr, %smpFixint* %yptr)

  %1 = tail call i32 (i8*, ...)* @printf(i8* getelementptr inbounds ([4 x i8]* @.int_printer, i32 0, i32 0), i32 %res) nounwind
  ret i32 0
}

declare i32 @printf(i8* nocapture, ...) nounwind
